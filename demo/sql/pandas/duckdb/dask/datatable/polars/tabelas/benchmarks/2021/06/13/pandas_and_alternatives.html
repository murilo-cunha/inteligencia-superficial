<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Manipulação de dados tabulares - Pandas e alternativas | Inteligência Superficial</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Manipulação de dados tabulares - Pandas e alternativas" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Pandas, SQL e comparações (Dask, Polars, Datatable, PandaSQL e DuckDB)" />
<meta property="og:description" content="Pandas, SQL e comparações (Dask, Polars, Datatable, PandaSQL e DuckDB)" />
<link rel="canonical" href="https://murilo-cunha.github.io/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html" />
<meta property="og:url" content="https://murilo-cunha.github.io/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html" />
<meta property="og:site_name" content="Inteligência Superficial" />
<meta property="og:image" content="https://images.unsplash.com/photo-1526716121440-dc3b4f254a0a?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=700&q=80" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-13T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://images.unsplash.com/photo-1526716121440-dc3b4f254a0a?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=700&q=80" />
<meta property="twitter:title" content="Manipulação de dados tabulares - Pandas e alternativas" />
<script type="application/ld+json">
{"description":"Pandas, SQL e comparações (Dask, Polars, Datatable, PandaSQL e DuckDB)","image":"https://images.unsplash.com/photo-1526716121440-dc3b4f254a0a?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=700&q=80","headline":"Manipulação de dados tabulares - Pandas e alternativas","@type":"BlogPosting","dateModified":"2021-06-13T00:00:00-05:00","datePublished":"2021-06-13T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://murilo-cunha.github.io/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html"},"url":"https://murilo-cunha.github.io/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/inteligencia-superficial/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://murilo-cunha.github.io/inteligencia-superficial/feed.xml" title="Inteligência Superficial" /><link rel="shortcut icon" type="image/x-icon" href="/inteligencia-superficial/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Manipulação de dados tabulares - Pandas e alternativas | Inteligência Superficial</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Manipulação de dados tabulares - Pandas e alternativas" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Pandas, SQL e comparações (Dask, Polars, Datatable, PandaSQL e DuckDB)" />
<meta property="og:description" content="Pandas, SQL e comparações (Dask, Polars, Datatable, PandaSQL e DuckDB)" />
<link rel="canonical" href="https://murilo-cunha.github.io/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html" />
<meta property="og:url" content="https://murilo-cunha.github.io/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html" />
<meta property="og:site_name" content="Inteligência Superficial" />
<meta property="og:image" content="https://images.unsplash.com/photo-1526716121440-dc3b4f254a0a?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=700&q=80" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-13T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://images.unsplash.com/photo-1526716121440-dc3b4f254a0a?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=700&q=80" />
<meta property="twitter:title" content="Manipulação de dados tabulares - Pandas e alternativas" />
<script type="application/ld+json">
{"description":"Pandas, SQL e comparações (Dask, Polars, Datatable, PandaSQL e DuckDB)","image":"https://images.unsplash.com/photo-1526716121440-dc3b4f254a0a?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=700&q=80","headline":"Manipulação de dados tabulares - Pandas e alternativas","@type":"BlogPosting","dateModified":"2021-06-13T00:00:00-05:00","datePublished":"2021-06-13T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://murilo-cunha.github.io/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html"},"url":"https://murilo-cunha.github.io/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://murilo-cunha.github.io/inteligencia-superficial/feed.xml" title="Inteligência Superficial" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><div class="wrapper-masthead">
  <div class="container">
    <header class="masthead clearfix"><a href="/inteligencia-superficial/" class="site-avatar"><img src="https://murilo-cunha.github.io/inteligencia-superficial/images/avatar.png" /></a><div class="site-info"><h1 class="header-title"><a class="site-title" rel="author site-title-h1" href="/inteligencia-superficial/">Inteligência Superficial</a>
        </h1>
        <p class="site-description">Mergulhando de cabeça em inteligência artificial e machine learning</p>
      </div><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>
        
        <div class="trigger"><a class="page-link" href="/inteligencia-superficial/sobre/">Sobre</a><a class="page-link" href="/inteligencia-superficial/recursos/">Outros recursos</a><a class="page-link" href="/inteligencia-superficial/pesquisa/">Pesquisa</a><a class="page-link" href="/inteligencia-superficial/categories/">Categorias</a></div>
      </nav></header>
  </div>
</div> 
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Manipulação de dados tabulares - Pandas e alternativas</h1><p class="page-description">Pandas, SQL e comparações (Dask, Polars, Datatable, PandaSQL e DuckDB)</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-06-13T00:00:00-05:00" itemprop="datePublished">
        Jun 13, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      12 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#demo">demo</a>
        &nbsp;
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#sql">sql</a>
        &nbsp;
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#pandas">pandas</a>
        &nbsp;
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#duckdb">duckdb</a>
        &nbsp;
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#dask">dask</a>
        &nbsp;
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#datatable">datatable</a>
        &nbsp;
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#polars">polars</a>
        &nbsp;
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#tabelas">tabelas</a>
        &nbsp;
      
        <a class="category-tags-link" href="/inteligencia-superficial/categories/#benchmarks">benchmarks</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/murilo-cunha/inteligencia-superficial/tree/master/_notebooks/2021-06-13-pandas_and_alternatives.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/inteligencia-superficial/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/murilo-cunha/inteligencia-superficial/master?filepath=_notebooks%2F2021-06-13-pandas_and_alternatives.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/inteligencia-superficial/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/murilo-cunha/inteligencia-superficial/blob/master/_notebooks/2021-06-13-pandas_and_alternatives.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/inteligencia-superficial/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#Introdução">Introdução </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Pandas">Pandas </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Dados">Dados </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Dask">Dask </a></li>
<li class="toc-entry toc-h2"><a href="#Polars">Polars </a></li>
<li class="toc-entry toc-h2"><a href="#Datatable">Datatable </a></li>
<li class="toc-entry toc-h2"><a href="#PandaSQL">PandaSQL </a></li>
<li class="toc-entry toc-h2"><a href="#DuckDB">DuckDB </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Mais-informações">Mais informações </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-06-13-pandas_and_alternatives.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introdução">
<a class="anchor" href="#Introdu%C3%A7%C3%A3o" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introdução<a class="anchor-link" href="#Introdu%C3%A7%C3%A3o"> </a>
</h1>
<p>Em machine learning, a gente sempre comenta como nós precisamos de dados. E precisamos de dados bem curados. Talvez você até já tenha ouvido a frase: "garbage in, garbage out", né?</p>
<p>Na vida real, isso é bem verdade. E gastar mais tempo criando novas features, ou limpando os dados acaba muitas vezes impactando os resultados dos modelos mais que qualquer outra coisa. Não é à toa que grande parte dos ganhadores das competições do <a href="https://www.kaggle.com/">Kaggle</a> usam os mesmo modelos - <a href="https://towardsdatascience.com/xgboost-lightgbm-and-other-kaggle-competition-favorites-6212e8b0e835">ensembles</a>. E, na maior parte, quem ganha são os que tem os melhores dados.</p>
<p>Então, antes de mexermos em modelos, temos que manipular os dados. Mas então como manipular esses dados?</p>
<h2 id="Pandas">
<a class="anchor" href="#Pandas" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pandas<a class="anchor-link" href="#Pandas"> </a>
</h2>
<p>A resposta mais comum é <a href="https://pandas.pydata.org/">pandas</a>! Se você já mexeu com dados, provavelmente já ouviu falar sobre essa biblioteca. Ela é, de longe, a mais popular pra manipulação de dados tabulares. Ela foi construída em cima de <a href="https://numpy.org/">NumPy</a>, que usa C++ por trás dos panos.</p>
<blockquote>
<p>Em Python temos o GIL que limita o uso de threads pra evitar que mais de um thread tente escrever/apagar as mesmas partes da memória ao mesmo tempo (<a href="https://pt.wikipedia.org/wiki/Condi%C3%A7%C3%A3o_de_corrida">condição de corrida</a>). Quando usamos Numpy e chegamos no nível de C, o programa não está sujeito ao GIL e então podemos parallelizar as coisas.
Mas se você já ouviu falar de pandas, é capaz que não tenha ouvido coisas boas. Especialmente quem vem da linguagem de programação em R usando o <a href="https://dplyr.tidyverse.org/">dplyr</a> tem o que falar 😅. O número de perguntas no <a href="https://stackoverflow.com/">StackOverflow</a> relacionadas à pandas cresceu bastante durante os anos. Parte pelo aumento em popularidade da biblioteca, mas parte pela dificuldade da API do pandas.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/murilo-cunha/inteligencia-superficial/master/images/copied_from_nb/2021-06-13-pandas_and_alternatives/stackoverflow_questions.png" alt="" title="Fonte: https://insights.stackoverflow.com/trends?tags=pandas%2Cnumpy%2Cdask%2Cspacy%2Ctensorflow%2Cpytorch%2Cscikit-learn%2Cpyspark%2Cpostgresql"></p>
<p>Além disso, existem vários pontos em que podemos otimizar a performance de pandas. Isso pelo fato da biblioteca ter sido criada em cima de uma outra. Vamos dar uma olhada na performance de pandas.</p>
<h3 id="Dados">
<a class="anchor" href="#Dados" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dados<a class="anchor-link" href="#Dados"> </a>
</h3>
<p>Vamos usar o TPC-H dataset, focando no <code>lineitem</code> e <code>orders</code>, que são as maiores tabelas que somam 1GB. Para medir o tempo de execução, vamos unir as duas tabelas, filtram as linhas, agrupam os dados e computamos alguns dados agregados (máximo, mínimo, etc.). O que estamos fazendo em si não é muito importante, mas é um tipo de transformação que encontraríamos na vida real.</p>
<p>Vamos tentar otimizar tudo ao máximo, e vamos focar na transformação dos dados</p>
<ul>
<li>Vamos medir o tempo da transformação (excluindo o tempo de ler os dados)</li>
<li>Vamos filtrar o quanto antes</li>
<li>Vamos encadear operações</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">lineitem</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">"l_orderkey"</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">"o_orderkey"</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"l_shipdate"</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s2">"1998-09-02"</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"o_orderpriority"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="s2">"1-URGENT"</span><span class="p">,</span> <span class="s2">"2-HIGH"</span><span class="p">)))</span>
    <span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">"l_returnflag"</span><span class="p">,</span> <span class="s2">"l_linestatus"</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">"l_extendedprice"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sum"</span><span class="p">,</span> <span class="s2">"min"</span><span class="p">,</span> <span class="s2">"max"</span><span class="p">,</span> <span class="s2">"mean"</span><span class="p">],</span>
        <span class="s2">"l_quantity"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sum"</span><span class="p">,</span> <span class="s2">"min"</span><span class="p">,</span> <span class="s2">"max"</span><span class="p">,</span> <span class="s2">"mean"</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 5.63 s, sys: 2.34 s, total: 7.97 s
Wall time: 8.09 s
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="4" halign="left">l_extendedprice</th>
      <th colspan="4" halign="left">l_quantity</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>sum</th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>sum</th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
    </tr>
    <tr>
      <th>l_returnflag</th>
      <th>l_linestatus</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A</th>
      <th>F</th>
      <td>2.267720e+10</td>
      <td>904.0</td>
      <td>104949.5</td>
      <td>38303.426664</td>
      <td>15123892</td>
      <td>1</td>
      <td>50</td>
      <td>25.545346</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">N</th>
      <th>F</th>
      <td>5.965302e+08</td>
      <td>920.0</td>
      <td>104049.0</td>
      <td>38461.006847</td>
      <td>397729</td>
      <td>1</td>
      <td>50</td>
      <td>25.643391</td>
    </tr>
    <tr>
      <th>O</th>
      <td>4.473406e+10</td>
      <td>901.0</td>
      <td>104749.5</td>
      <td>38267.695102</td>
      <td>29826993</td>
      <td>1</td>
      <td>50</td>
      <td>25.515466</td>
    </tr>
    <tr>
      <th>R</th>
      <th>F</th>
      <td>2.268310e+10</td>
      <td>906.0</td>
      <td>104899.5</td>
      <td>38240.140532</td>
      <td>15126938</td>
      <td>1</td>
      <td>50</td>
      <td>25.501645</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Executando todas essas transformações demorou 10.3 segundos. Mas podemos ser mais eficientes. Por exemplo, poderíamos esquecer várias colunas já que no fim só estamos interessados em <code>l_returnflag</code>, <code>l_linestatus</code>, <code>l_extendedprice</code> e <code>l_quantity</code> (além das colunas que usamos para filtrar os dados). Também somos ineficientes quando temos de filtrar e agregar os valores (escaneamos a tabela duas vezes, quando poderíamos fazer isso de uma vez só). Além disso, poderíamos melhorar na implementação de paralelismo e do algoritmo.</p>
<p>Vamos então deixar pandas de lado e ver como podemos melhorar isso.</p>
<p><img src="https://media.giphy.com/media/EPcvhM28ER9XW/giphy.gif" alt=""></p>
<h2 id="Dask">
<a class="anchor" href="#Dask" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dask<a class="anchor-link" href="#Dask"> </a>
</h2>
<p><a href="https://docs.dask.org/en/latest/dataframe.html">Dask</a> provavelmente é a primeira solução que vem à cabeça. Dask basicamente cria várias tabelas em pandas e vai paralelizando as operações em cores diferentes. Também é mais eficiente por usar <a href="https://pt.wikipedia.org/wiki/Avalia%C3%A7%C3%A3o_pregui%C3%A7osa">avaliação preguiçosa</a> (lazy evaluation) - primeiro traçamos o que queremos fazer e depois mandamos o computador executar as transformações. Isso nos deixa otimizar a computação das transformações (por exemplo, podemos filtrar linhas antes de fazer qualquer outra coisa, mesmo que o código não represente isso).</p>
<p><img src="https://media.giphy.com/media/26ufnwz3wDUli7GU0/giphy.gif" alt=""></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse</span>
<span class="c1"># dask</span>
<span class="n">dd_lineitem</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">lineitem</span><span class="p">,</span> <span class="n">npartitions</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dd_orders</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">npartitions</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it
<span class="n">dd_lineitem</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dd_orders</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">"l_orderkey"</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">"o_orderkey"</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"l_shipdate"</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s2">"1998-09-02"</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"o_orderpriority"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="s2">"1-URGENT"</span><span class="p">,</span> <span class="s2">"2-HIGH"</span><span class="p">)))</span>
    <span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">"l_returnflag"</span><span class="p">,</span> <span class="s2">"l_linestatus"</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">"l_extendedprice"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sum"</span><span class="p">,</span> <span class="s2">"min"</span><span class="p">,</span> <span class="s2">"max"</span><span class="p">,</span> <span class="s2">"mean"</span><span class="p">],</span>
        <span class="s2">"l_quantity"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sum"</span><span class="p">,</span> <span class="s2">"min"</span><span class="p">,</span> <span class="s2">"max"</span><span class="p">,</span> <span class="s2">"mean"</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>6.14 s ± 20.1 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Usando Dask e com essas melhorias de parallelismo a gente ganha alguns segundos. O que faz Dask muito popular é o fato de ele imitar a API do Pandas. Aí fica muito mais fácil de pegar e começar a codar. Mas ainda assim, estamos usando Pandas. Temos espaços para melhorias.</p>
<h2 id="Polars">
<a class="anchor" href="#Polars" aria-hidden="true"><span class="octicon octicon-link"></span></a>Polars<a class="anchor-link" href="#Polars"> </a>
</h2>
<p><a href="https://pola-rs.github.io/polars-book/">Polars</a> é uma biblioteca implementada em <a href="https://www.rust-lang.org/">Rust</a>, que é muito eficiente em termos de velocidade e uso de memória. O lugar de Polars (de acordo com a documentação) é para quando os dados são muito grandes para Pandas mas muito pequenos para realizar as transformações num cluster de máquinas (Spark). Ou seja, se os dados são muito grandes pra sua máquina, mesmo depois de filtrar algumas entradas, precisamos procurar outras soluções (o que é verdade pra Dask e todas as outras bibliotecas que vamos ver aqui). E assim como Dask, Polars vai usar todas as threads da sua máquina.</p>
<p>Uma outra idéia de Polars é permitir o use da <a href="https://pt.wikipedia.org/wiki/Avalia%C3%A7%C3%A3o_ansiosa">avaliação ansiosa</a> (eager evaluation), como em Pandas e da <a href="https://pt.wikipedia.org/wiki/Avalia%C3%A7%C3%A3o_pregui%C3%A7osa">avaliação preguiçosa</a> (lazy evaluation), como em Dask. A availação ansiosa é como em Pandas, e a API é bem parecida. A API da avaliação preguiçosa é um pouco diferente, e é otimizada pelos mesmo motivos que citamos quando falamos de Dask (paralelização e otimização das transformações).</p>
<p><img src="https://media.giphy.com/media/2FmmbTZMl6lQQ/giphy.gif" alt=""></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse</span>
<span class="c1"># polars</span>
<span class="n">pl_lineitem</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lineitem</span><span class="p">)</span>
<span class="n">pl_orders</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it
<span class="n">pl_lineitem</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pl_orders</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">"l_orderkey"</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">"o_orderkey"</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"l_shipdate"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="s2">"1998-09-02"</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"o_orderpriority"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"1-URGENT"</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"o_orderpriority"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"2-HIGH"</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">"l_returnflag"</span><span class="p">,</span> <span class="s2">"l_linestatus"</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">"l_extendedprice"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sum"</span><span class="p">,</span> <span class="s2">"min"</span><span class="p">,</span> <span class="s2">"max"</span><span class="p">,</span> <span class="s2">"mean"</span><span class="p">],</span>
        <span class="s2">"l_quantity"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sum"</span><span class="p">,</span> <span class="s2">"min"</span><span class="p">,</span> <span class="s2">"max"</span><span class="p">,</span> <span class="s2">"mean"</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1.87 s ± 1.03 s per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Com isso conseguimos reduzir o tempo em <strong>&lt;30%</strong> (comparando com Dask)! Então, o que ainda podemos melhorar? Quando usamos a avaliação ansiosa, ainda podemos melhorar a execução das queries. Além disso, a biblioteca não tem tantas funções quanto Pandas (e consequentemente Dask). E falando em Pandas, se a API é igual, e você não está satisfeito com ela, provavelmente não vai estar muito contente com a API do Polars também.</p>
<h2 id="Datatable">
<a class="anchor" href="#Datatable" aria-hidden="true"><span class="octicon octicon-link"></span></a>Datatable<a class="anchor-link" href="#Datatable"> </a>
</h2>
<p>Se você gosta de R e está fazendo a transição para python, talvez essa seja uma boa opção. Datatable é inspirada pela biblioteca em R <a href="https://rdatatable.gitlab.io/data.table/">data.table</a>. A API é parecida, e tem várias otimizações para tratar com dados grandes. Que cabem <strong>ou não</strong> em memória (dados que não caberiam em memória usando Pandas cabem quando usamos Datatable). Essa biblioteca também usa algoritmos que supportam o paralelismo em diferentes <a href="https://pt.wikipedia.org/wiki/Thread_(computa%C3%A7%C3%A3o">threads</a>), aumentando de novo a velocidade de execução.</p>
<p><img src="https://media.giphy.com/media/rGlAZysKBcjRCkAX7S/giphy.gif" alt=""></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse</span>
<span class="c1"># datatable</span>
<span class="n">dt_lineitem</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">lineitem</span><span class="p">)</span>
<span class="n">dt_orders</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>

<span class="c1"># preparação</span>
<span class="n">dt_lineitem</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"l_orderkey"</span><span class="p">:</span> <span class="s2">"orderkey"</span><span class="p">}</span>
<span class="n">dt_orders</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"o_orderkey"</span><span class="p">:</span> <span class="s2">"orderkey"</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it
<span class="c1"># dt_lineitem.key = "orderkey"  # não podemos usar como `key` existem valores repetidos</span>
<span class="n">dt_orders</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">"orderkey"</span>

<span class="c1"># executando a query</span>
<span class="n">dt_lineitem</span><span class="p">[</span>
    <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">o_orderpriority</span> <span class="o">==</span> <span class="s2">"1-URGENT"</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">o_orderpriority</span> <span class="o">==</span> <span class="s2">"2-HIGH"</span><span class="p">),</span>
    <span class="p">:,</span>
    <span class="n">join</span><span class="p">(</span><span class="n">dt_orders</span><span class="p">),</span>
<span class="p">][</span>
    <span class="p">:,</span>
    <span class="p">{</span>
        <span class="s2">"sum(l_extendedprice)"</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_extendedprice</span><span class="p">),</span>
        <span class="s2">"min(l_extendedprice)"</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_extendedprice</span><span class="p">),</span>
        <span class="s2">"max(l_extendedprice)"</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_extendedprice</span><span class="p">),</span>
        <span class="s2">"mean(l_extendedprice)"</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_extendedprice</span><span class="p">),</span>
        <span class="s2">"sum(l_quantity)"</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_quantity</span><span class="p">),</span>
        <span class="s2">"min(l_quantity)"</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_quantity</span><span class="p">),</span>
        <span class="s2">"max(l_quantity)"</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_quantity</span><span class="p">),</span>
        <span class="s2">"mean(l_quantity)"</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_quantity</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">by</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">l_returnflag</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">l_linestatus</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1.32 s ± 106 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>~10%</strong> do tempo (comparando com Pandas)! Você pode reparar também como a API muda bastante. Pessoalmente, foi um pouco mais trabalhoso pra escrever o código equivalente, mas na documentação eles também ofereçem uma comparação da API do Datatable com a API do Pandas, o que ajuda bastante.</p>
<p>Além disso, eles também comparam a API do Datatable com SQL. Afinal de contas, SQL é muito usado até hoje, e mais familiar pra muitas pessoas. Além disso, SQL tem sido usado bastante através dos anos e oferece uma maneira eficiente de manipular dados tabulars. Quando os dados aumentam ainda mais e nos tornamos para um método distribuído como <a href="https://spark.apache.org/">Spark</a> ainda podemos usar <a href="https://spark.apache.org/docs/latest/sql-programming-guide.html">SparkSQL</a>. Spark e SQL precisam de um <a href="https://pt.wikipedia.org/wiki/Cluster">cluster</a> e de um <a href="https://pt.wikipedia.org/wiki/Servidor_(computa%C3%A7%C3%A3o">servidor</a>) próprio pra executar as transformações. Mas existem algumas bibliotecas que nos permitem usar SQL para manipular dados em dataframes.</p>
<h2 id="PandaSQL">
<a class="anchor" href="#PandaSQL" aria-hidden="true"><span class="octicon octicon-link"></span></a>PandaSQL<a class="anchor-link" href="#PandaSQL"> </a>
</h2>
<p>PandasSQL é uma solução mais antiga. A biblioteca permite usar SQL (SQLite) em tabelas Pandas. Você só tem que passar a query em SQL e as variáveis locais. Por trás dos panos, eles criam um <a href="https://pt.wikipedia.org/wiki/Mecanismo_de_armazenamento">SQL engine</a> usando SQLAlchemy e os métodos de <code>to_sql</code> e <code>read_sql</code> de Pandas. O que faz possível executar queries em Pandas, mas é um truque, que acaba sendo bem ineficiente em relação a tempo de execução e uso de memória #gambiarra</p>
<p><img src="https://media.giphy.com/media/L2HCO7avkR5H9MvS9Y/giphy.gif" alt=""></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># hide_output</span>
<span class="kn">from</span> <span class="nn">pandasql</span> <span class="kn">import</span> <span class="n">sqldf</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

<span class="n">_df</span> <span class="o">=</span> <span class="n">sqldf</span><span class="p">(</span>
    <span class="sd">"""</span>
<span class="sd">SELECT l_returnflag,</span>
<span class="sd">       l_linestatus,</span>
<span class="sd">       SUM(l_extendedprice),</span>
<span class="sd">       MIN(l_extendedprice),</span>
<span class="sd">       MAX(l_extendedprice),</span>
<span class="sd">       AVG(l_extendedprice),</span>
<span class="sd">       SUM(l_quantity),</span>
<span class="sd">       MIN(l_quantity),</span>
<span class="sd">       MAX(l_quantity),</span>
<span class="sd">       AVG(l_quantity)</span>
<span class="sd">FROM lineitem AS lineitem</span>
<span class="sd">JOIN orders AS orders ON (l_orderkey=o_orderkey)</span>
<span class="sd">WHERE l_shipdate &lt;= DATE '1998-09-02'</span>
<span class="sd">  AND o_orderpriority IN ('1-URGENT', '2-HIGH')</span>
<span class="sd">GROUP BY l_returnflag,</span>
<span class="sd">         l_linestatus</span>
<span class="sd">"""</span><span class="p">,</span>
    <span class="nb">globals</span><span class="p">(),</span>
<span class="p">)</span>

<span class="c1"># o código retorna um erro interno (`OperationalError`) - visite o notebook para mais detalhes</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Wall time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
<span class="n">_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Não muito bom... Mas <strong>deve</strong> existir outro jeito de usar SQL em Pandas, e ainda aproveitando a eficiência de SQL, não? Na verdade sim. Acontece que tem gente que basicamente reconstruiu um servidor de SQL pra ser executado em memória, com uma API em python!</p>
<h2 id="DuckDB">
<a class="anchor" href="#DuckDB" aria-hidden="true"><span class="octicon octicon-link"></span></a>DuckDB<a class="anchor-link" href="#DuckDB"> </a>
</h2>
<p>DuckDB permite aos desenvolvedores à executar queries nas suas tabelas em Pandas ou direto de arquivos CSV, parquet, etc. A biblioteca foi desenvolvida com C++ por trás dos panos, e também permite paralelização e otimização da query. Ou seja, eles evitam problemas que encontramos em outras bibliotecas - antes nós tinhamos de escanear a tabela duas vezes quando executamos nossa query: uma para filtrar as linhas e outra vez pra agroupar os dados. Isso não acontece com DuckDB. Eles também são inteligente no uso de memória.</p>
<p>Também pensando no ambiente python, onde Pandas ainda é prevalente, eles oferecem métodos para transformar os dados numa tabela Pandas.</p>
<p><img src="https://media.giphy.com/media/vIJaz7nMJhTUc/giphy.gif" alt=""></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># ler arquivos em parquet e colocar em uma dataframe</span>
<span class="n">lineitem</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"SELECT * FROM 'lineitemsf1.snappy.parquet'"</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"SELECT * FROM 'orders.parquet'"</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>

<span class="n">lineitem</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>l_orderkey</th>
      <th>l_partkey</th>
      <th>l_suppkey</th>
      <th>l_linenumber</th>
      <th>l_quantity</th>
      <th>l_extendedprice</th>
      <th>l_discount</th>
      <th>l_tax</th>
      <th>l_returnflag</th>
      <th>l_linestatus</th>
      <th>l_shipdate</th>
      <th>l_commitdate</th>
      <th>l_receiptdate</th>
      <th>l_shipinstruct</th>
      <th>l_shipmode</th>
      <th>l_comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>155190</td>
      <td>7706</td>
      <td>1</td>
      <td>17</td>
      <td>21168.23</td>
      <td>0.04</td>
      <td>0.02</td>
      <td>N</td>
      <td>O</td>
      <td>1996-03-13</td>
      <td>1996-02-12</td>
      <td>1996-03-22</td>
      <td>DELIVER IN PERSON</td>
      <td>TRUCK</td>
      <td>egular courts above the</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>67310</td>
      <td>7311</td>
      <td>2</td>
      <td>36</td>
      <td>45983.16</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>N</td>
      <td>O</td>
      <td>1996-04-12</td>
      <td>1996-02-28</td>
      <td>1996-04-20</td>
      <td>TAKE BACK RETURN</td>
      <td>MAIL</td>
      <td>ly final dependencies: slyly bold</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>63700</td>
      <td>3701</td>
      <td>3</td>
      <td>8</td>
      <td>13309.60</td>
      <td>0.10</td>
      <td>0.02</td>
      <td>N</td>
      <td>O</td>
      <td>1996-01-29</td>
      <td>1996-03-05</td>
      <td>1996-01-31</td>
      <td>TAKE BACK RETURN</td>
      <td>REG AIR</td>
      <td>riously. regular, express dep</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>2132</td>
      <td>4633</td>
      <td>4</td>
      <td>28</td>
      <td>28955.64</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>N</td>
      <td>O</td>
      <td>1996-04-21</td>
      <td>1996-03-30</td>
      <td>1996-05-16</td>
      <td>NONE</td>
      <td>AIR</td>
      <td>lites. fluffily even de</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>24027</td>
      <td>1534</td>
      <td>5</td>
      <td>24</td>
      <td>22824.48</td>
      <td>0.10</td>
      <td>0.04</td>
      <td>N</td>
      <td>O</td>
      <td>1996-03-30</td>
      <td>1996-03-14</td>
      <td>1996-04-01</td>
      <td>NONE</td>
      <td>FOB</td>
      <td>pending foxes. slyly re</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it
<span class="c1"># executar uma query na nossa tabela Pandas</span>
<span class="n">duckdb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="sd">"""</span>
<span class="sd">SELECT l_returnflag,</span>
<span class="sd">       l_linestatus,</span>
<span class="sd">       SUM(l_extendedprice),</span>
<span class="sd">       MIN(l_extendedprice),</span>
<span class="sd">       MAX(l_extendedprice),</span>
<span class="sd">       AVG(l_extendedprice),</span>
<span class="sd">       SUM(l_quantity),</span>
<span class="sd">       MIN(l_quantity),</span>
<span class="sd">       MAX(l_quantity),</span>
<span class="sd">       AVG(l_quantity)</span>
<span class="sd">FROM lineitem AS lineitem</span>
<span class="sd">JOIN orders AS orders ON (l_orderkey=o_orderkey)</span>
<span class="sd">WHERE l_shipdate &lt;= DATE '1998-09-02'</span>
<span class="sd">  AND o_orderpriority IN ('1-URGENT', '2-HIGH')</span>
<span class="sd">GROUP BY l_returnflag,</span>
<span class="sd">         l_linestatus</span>
<span class="sd">"""</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>648 ms ± 5.47 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Além de ser a mais rápida, repare que DuckDB já pega as variáveis locais quando tentamos executar as queries. A biblioteca também suporta (código testado) vários tipos de SQL, incluindo PostgreSQL, MySQL e SQLite.</p>
<h1 id="Mais-informações">
<a class="anchor" href="#Mais-informa%C3%A7%C3%B5es" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mais informações<a class="anchor-link" href="#Mais-informa%C3%A7%C3%B5es"> </a>
</h1>
<p>O DuckDB foi a solução mais rápida. Mas como você deve ter imaginado, esse não é sempre o caso. Tudo depende do volume de dados que temos e das transformações que vamos fazer. Os <a href="https://www.h2o.ai/blog/speed-up-your-data-analysis-with-pythons-datatable-package/#:~:text=H2O%20AI%20Hybrid%20Cloud&amp;text=Deploy%20models%20in%20any%20environment,%2C%20and%20real%2Dtime%20monitoring.&amp;text=H2O%20Wave%20enables%20fast%20development,light%2Dweight%20Python%20development%20framework.">criadores do Datatable</a> também comparam o tempo de execução das queries para diferentes cenários. As comparações são atualizadas com o passar do tempo e você pode encontrar os últimos resultados <a href="https://h2oai.github.io/db-benchmark/">aqui</a>.</p>
<p>Para os interessados, também tem um artigo muito interessante no blog do DuckDB, onde eles explicam um pouco os motivos quais DuckDB tem uma performance elevada à Pandas, e como que podemos otimizar nossas queries (mesmo que só em Pandas). Esse post também foi inspirado no blog post deles (as queries e os dados). Vale à pena dar uma olhada.</p>
<p>Quando falamos de Big Data também não podemos deixar de falar de outras tecnologias, como Spark, Apache Beam, etc. Quando os dados são muito grandes pra uma máquina só, o que nos resta é utilizar um cluster de computadores e paralelizar as computações e dividir o uso de memória - <a href="https://pt.wikipedia.org/wiki/Escalabilidade">escalabilidade horizontal</a>. Mas com esses clusters precisamos de uma parte administrativa maior, e não seria algo que qualquer um poderia testar rapidamente. Nesse post incluímos apenas os casos de quando os dados caberiam em uma máquina, e estamos avaliando a eficiência de bibliotecas em python (existem outras bibliotecas em outras linguagens que também são bem eficientes).</p>
<p>Em outras palavras, nós comparamos algumas ferramentas pra um específico caso, mas pra determinar a <strong>melhor</strong> ferramenta, precisamos ir de caso-a-caso. Qual o volume de dados? Precisamos um cluster? Qual o tempo de execução aceitável? Qual o nível técnico da equipe?</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="murilo-cunha/inteligencia-superficial"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/inteligencia-superficial/demo/sql/pandas/duckdb/dask/datatable/polars/tabelas/benchmarks/2021/06/13/pandas_and_alternatives.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/inteligencia-superficial/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/inteligencia-superficial/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/inteligencia-superficial/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Inscreva-se</span>
          </a>
        </p>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Licença Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Inteligência Superficial</span> de <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/murilo-cunha/inteligencia-superficial" property="cc:attributionName" rel="cc:attributionURL">Murilo Cunha</a> está licenciado com uma Licença <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons - Atribuição-NãoComercial-CompartilhaIgual 4.0 Internacional</a>.
      </div>
      <!-- <div class="footer-col">
        <p>Mergulhando de cabeça em inteligência artificial e machine learning</p>
      </div> -->
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/murilo-cunha" title="murilo-cunha"><svg class="svg-icon grey"><use xlink:href="/inteligencia-superficial/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/murilo-cunha" title="murilo-cunha"><svg class="svg-icon grey"><use xlink:href="/inteligencia-superficial/assets/minima-social-icons.svg#linkedin"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
