---
keywords: fastai
description: Comparando strings e aproximando igualdades
title: Fuzzy string matching
toc: true 
badges: true
comments: true
categories: [demo, fuzzy string matching, nlp]
image: https://www.the-automator.com/wp-content/uploads/2016/01/fuzzy.gif
nb_path: _notebooks/2021-06-10-fuzzy_string_matching.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-06-10-fuzzy_string_matching.ipynb
-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introdu&#231;&#227;o">Introdu&#231;&#227;o<a class="anchor-link" href="#Introdu&#231;&#227;o"> </a></h1><p>V√°rias vezes, n√≥s temos texto como parte dos nossos dados (strings). Em v√°rias aplica√ß√µes (n√£o s√≥ em machine learning), esses dados vem de usu√°rios - quando voc√™ preenche um formul√°rio, coloca seu nome, endere√ßo, etc.</p>
<p>O problema √© que muitas pessoas n√£o escrevem os dados igual. Por exemplo, eu ja vi meu nome escrito como <code>murilo</code>, <code>Murilo</code>, <code>murilio</code>, <code>murillo</code>, <code>Murilo</code>, <code>Mr. Murilo</code>, etc. Mas todos essas strings deveriam se referir pra mesma coisa. Como que a gente pode decidir se esses s√£o iguais ou n√£o?</p>
<h1 id="Fuzzy-string-matching">Fuzzy string matching<a class="anchor-link" href="#Fuzzy-string-matching"> </a></h1><p><img src="https://media.giphy.com/media/dB1CUdNMPn4aVaISWe/giphy.gif" alt=""></p>
<p>Os algoritmos que resolvem esse problema se chamam <code>fuzzy string matching</code>, ou aproxima√ß√µes em compara√ß√µes de strings. Um algoritmo popular √© a <a href="https://pt.wikipedia.org/wiki/Dist%C3%A2ncia_Levenshtein">dist√¢ncia Levenshtein</a>, que basicamente vai computando quantas altera√ß√µes voc√™ teria de fazer entre as duas strings. Por exemplo, indo de <code>kitten</code> para <code>sitting</code> (exemplo do <a href="https://pt.wikipedia.org/wiki/Dist%C3%A2ncia_Levenshtein">Wikipedia</a>:</p>
<p>{% raw %}
$$kitten \rightarrow \textbf{s}itten\rightarrow sitt\textbf{i}n \rightarrow sittin\textbf{g}$$
{% endraw %}</p>
<p>A dist√¢ncia Levenshtein nesse caso √© 3, porque temos 3 transforma√ß√µes entre a palavra de origem e a palavra de destino:</p>
<ol>
<li>Substitui√ß√£o de <code>k</code> por <code>s</code></li>
<li>Substitui√ß√£o de <code>e</code> por <code>i</code></li>
<li>inser√ß√£o de <code>g</code> no final</li>
</ol>
<p>E essa √© a id√©ia principal (e passando por cima de alguns detalhes üòÖ). Simples, n√©? O algoritmo tamb√©m √© implementado com recurs√£o por efici√™ncia, mas qu√£o efficiente √© esse algoritmo? Na vida real (especialmente em machine learning), n√≥s temos muitos dados, ent√£o √© importante vermos como que esse algoritmo escala. Isso √©, quanto tempo demora/quanta mem√≥ria vamos usar enquando o volume de dados aumenta?</p>
<h2 id="FuzzyWuzzy"><code>FuzzyWuzzy</code><a class="anchor-link" href="#FuzzyWuzzy"> </a></h2><p><code>FuzzyWuzzy</code> √© uma biblioteca em python (bem popular) que implementa esse algoritmo. Al√©m disso, o pacote tamb√©m oferece uma vers√£o mais r√°pida que faz algumas aproxima√ß√µes. Vamos ver como funciona o API.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># exemplo da documenta√ß√£o da biblioteca</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">process</span>

<span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Atlanta Falcons&quot;</span><span class="p">,</span> <span class="s2">&quot;New York Jets&quot;</span><span class="p">,</span> <span class="s2">&quot;New York Giants&quot;</span><span class="p">,</span> <span class="s2">&quot;Dallas Cowboys&quot;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">timeit</span> process.extract(&quot;new york jets&quot;, choices, limit=2)  # s√≥ pra registrar o tempo
<span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">&quot;new york jets&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>89.3 ¬µs ¬± 1.1 ¬µs per loop (mean ¬± std. dev. of 7 runs, 10000 loops each)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(&#39;New York Jets&#39;, 100), (&#39;New York Giants&#39;, 79)]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">timeit</span> process.extractOne(&quot;cowboys&quot;, choices)  # s√≥ pra registrar o tempo
<span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="s2">&quot;cowboys&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>191 ¬µs ¬± 1.45 ¬µs per loop (mean ¬± std. dev. of 7 runs, 10000 loops each)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;Dallas Cowboys&#39;, 90)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>E √© isso! Mas mais uma vez, quanto tempo ser√° que demora quando temos mais dados? Vamos ver.</p>
<h2 id="Conectando-datasets">Conectando datasets<a class="anchor-link" href="#Conectando-datasets"> </a></h2><p>Um outro caso que √© importante √© quando temos dois datasets (tabelas nesse caso), algumas colunas tem os mesmos dados, mas elas est√£o escritos de maneiras diferentes! Ou ent√£o, quando os dados se repetem, e temos que deduplicar os dados. Isso acontece por exemplo quando o usu√°rio se registra mas coloca um email ou nome errado, ent√£o preenche o formul√°rio de novo. Vamos ver um exemplo.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">recordlinkage.datasets</span> <span class="kn">import</span> <span class="n">load_febrl1</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">load_febrl1</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>given_name</th>
      <th>surname</th>
      <th>street_number</th>
      <th>address_1</th>
      <th>address_2</th>
      <th>suburb</th>
      <th>postcode</th>
      <th>state</th>
      <th>date_of_birth</th>
      <th>soc_sec_id</th>
    </tr>
    <tr>
      <th>rec_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>rec-223-org</th>
      <td>NaN</td>
      <td>waller</td>
      <td>6</td>
      <td>tullaroop street</td>
      <td>willaroo</td>
      <td>st james</td>
      <td>4011</td>
      <td>wa</td>
      <td>19081209</td>
      <td>6988048</td>
    </tr>
    <tr>
      <th>rec-122-org</th>
      <td>lachlan</td>
      <td>berry</td>
      <td>69</td>
      <td>giblin street</td>
      <td>killarney</td>
      <td>bittern</td>
      <td>4814</td>
      <td>qld</td>
      <td>19990219</td>
      <td>7364009</td>
    </tr>
    <tr>
      <th>rec-373-org</th>
      <td>deakin</td>
      <td>sondergeld</td>
      <td>48</td>
      <td>goldfinch circuit</td>
      <td>kooltuo</td>
      <td>canterbury</td>
      <td>2776</td>
      <td>vic</td>
      <td>19600210</td>
      <td>2635962</td>
    </tr>
    <tr>
      <th>rec-10-dup-0</th>
      <td>kayla</td>
      <td>harrington</td>
      <td>NaN</td>
      <td>maltby circuit</td>
      <td>coaling</td>
      <td>coolaroo</td>
      <td>3465</td>
      <td>nsw</td>
      <td>19150612</td>
      <td>9004242</td>
    </tr>
    <tr>
      <th>rec-227-org</th>
      <td>luke</td>
      <td>purdon</td>
      <td>23</td>
      <td>ramsay place</td>
      <td>mirani</td>
      <td>garbutt</td>
      <td>2260</td>
      <td>vic</td>
      <td>19831024</td>
      <td>8099933</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vamos focar no nome completo, ou seja o <code>given_name</code> e <code>surname</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;given_name&quot;</span><span class="p">,</span> <span class="s2">&quot;surname&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;given_name&quot;</span><span class="p">,</span> <span class="s2">&quot;surname&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;given_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;surname&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rec_id</th>
      <th>full_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>rec-223-org</td>
      <td>waller</td>
    </tr>
    <tr>
      <th>1</th>
      <td>rec-122-org</td>
      <td>lachlan berry</td>
    </tr>
    <tr>
      <th>2</th>
      <td>rec-373-org</td>
      <td>deakin sondergeld</td>
    </tr>
    <tr>
      <th>3</th>
      <td>rec-10-dup-0</td>
      <td>kayla harrington</td>
    </tr>
    <tr>
      <th>4</th>
      <td>rec-227-org</td>
      <td>luke purdon</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vamos fazer todas as compara√ß√µes poss√≠veis! Esse dataset tem s√≥ 500 entradas ent√£o n√£o tem muito problema</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;cross&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>  <span class="c1"># cria todas as combina√ß√µes e depois mistura as linhas</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_name_x&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_name_y&quot;</span><span class="p">]</span>
<span class="p">]</span>  <span class="c1"># vamos retirar as que s√£o exatamente iguais</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;rec_id_x&quot;</span><span class="p">,</span> <span class="s2">&quot;rec_id_y&quot;</span><span class="p">,</span> <span class="s2">&quot;full_name_x&quot;</span><span class="p">,</span> <span class="s2">&quot;full_name_y&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>  <span class="c1"># reorganizando as colunas</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_name_x&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_name_y&quot;</span><span class="p">])</span>
<span class="p">)</span>  <span class="c1"># criando a coluna pra comparar os nomes</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rec_id_x</th>
      <th>rec_id_y</th>
      <th>full_name_x</th>
      <th>full_name_y</th>
      <th>names</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>rec-498-dup-0</td>
      <td>rec-372-dup-0</td>
      <td>claire crook</td>
      <td>talia ho</td>
      <td>(claire crook, talia ho)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>rec-484-org</td>
      <td>rec-220-org</td>
      <td>jacynta hoffman</td>
      <td>tyler heerey</td>
      <td>(jacynta hoffman, tyler heerey)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>rec-410-dup-0</td>
      <td>rec-261-dup-0</td>
      <td>sachin connerty</td>
      <td>wilde</td>
      <td>(sachin connerty,  wilde)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>rec-54-org</td>
      <td>rec-246-dup-0</td>
      <td>emiily morrison</td>
      <td>burford jack</td>
      <td>(emiily morrison, burford jack)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>rec-370-dup-0</td>
      <td>rec-386-dup-0</td>
      <td>rourke webv</td>
      <td>dylan dolby</td>
      <td>(rourke webv, dylan dolby)</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>E agora podemos computar o algoritmo!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;fuzzywuzzy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 2.94 s, sys: 59.6 ms, total: 3 s
Wall time: 3.03 s
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rec_id_x</th>
      <th>rec_id_y</th>
      <th>full_name_x</th>
      <th>full_name_y</th>
      <th>names</th>
      <th>fuzzywuzzy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>rec-498-dup-0</td>
      <td>rec-372-dup-0</td>
      <td>claire crook</td>
      <td>talia ho</td>
      <td>(claire crook, talia ho)</td>
      <td>40</td>
    </tr>
    <tr>
      <th>1</th>
      <td>rec-484-org</td>
      <td>rec-220-org</td>
      <td>jacynta hoffman</td>
      <td>tyler heerey</td>
      <td>(jacynta hoffman, tyler heerey)</td>
      <td>22</td>
    </tr>
    <tr>
      <th>2</th>
      <td>rec-410-dup-0</td>
      <td>rec-261-dup-0</td>
      <td>sachin connerty</td>
      <td>wilde</td>
      <td>(sachin connerty,  wilde)</td>
      <td>19</td>
    </tr>
    <tr>
      <th>3</th>
      <td>rec-54-org</td>
      <td>rec-246-dup-0</td>
      <td>emiily morrison</td>
      <td>burford jack</td>
      <td>(emiily morrison, burford jack)</td>
      <td>15</td>
    </tr>
    <tr>
      <th>4</th>
      <td>rec-370-dup-0</td>
      <td>rec-386-dup-0</td>
      <td>rourke webv</td>
      <td>dylan dolby</td>
      <td>(rourke webv, dylan dolby)</td>
      <td>18</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Para a nossa tabela com 998512 linhas, o algoritmo demorou 2.9 segundos. Nada mal. E as compara√ß√µes parecem boas! Alguns exemplos de igualdade:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;full_name_x&quot;</span><span class="p">,</span> <span class="s2">&quot;full_name_y&quot;</span><span class="p">,</span> <span class="s2">&quot;fuzzywuzzy&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="s2">&quot;fuzzywuzzy&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>full_name_x</th>
      <th>full_name_y</th>
      <th>fuzzywuzzy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>926629</th>
      <td>charldotte campbell</td>
      <td>charlotte campbell</td>
      <td>97</td>
    </tr>
    <tr>
      <th>463495</th>
      <td>lucas rawldings</td>
      <td>lucas rawlings</td>
      <td>97</td>
    </tr>
    <tr>
      <th>890513</th>
      <td>john van't hof</td>
      <td>john van'wt hof</td>
      <td>97</td>
    </tr>
    <tr>
      <th>969177</th>
      <td>jaden humphkreys</td>
      <td>jaden humphreys</td>
      <td>97</td>
    </tr>
    <tr>
      <th>680776</th>
      <td>kirah mccarthy</td>
      <td>kirrah mccarthy</td>
      <td>97</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>E alguns exemplos de desigualdade:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;full_name_x&quot;</span><span class="p">,</span> <span class="s2">&quot;full_name_y&quot;</span><span class="p">,</span> <span class="s2">&quot;fuzzywuzzy&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="s2">&quot;fuzzywuzzy&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>full_name_x</th>
      <th>full_name_y</th>
      <th>fuzzywuzzy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>689287</th>
      <td>ruby riding</td>
      <td>takeisha smallacombe</td>
      <td>6</td>
    </tr>
    <tr>
      <th>585410</th>
      <td>timothy mccarthy</td>
      <td>annablle kounis</td>
      <td>6</td>
    </tr>
    <tr>
      <th>232904</th>
      <td>jacynta hoffman</td>
      <td>brooke durbridge</td>
      <td>6</td>
    </tr>
    <tr>
      <th>775239</th>
      <td>annablle kounis</td>
      <td>timothy mccarthy</td>
      <td>6</td>
    </tr>
    <tr>
      <th>148505</th>
      <td>brooke durbridge</td>
      <td>jacynta hoffman</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vamos olhar o tempo mais de perto... Ser√° que a gente poderia melhorar isso?</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">timeit</span> df[&quot;names&quot;].apply(lambda x: fuzz.ratio(x[0], x[1]))
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2.99 s ¬± 44.4 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="RapidFuzz"><code>RapidFuzz</code><a class="anchor-link" href="#RapidFuzz"> </a></h2><p><code>RapidFuzz</code> √© uma outra biblioteca em python. Mais nova, que tem algumas pequenas diferen√ßas:</p>
<ul>
<li>A li√ßensa que eles est√£o usando √© mais permissiva. Aqui voc√™ est√° livre pra usar qualquer li√ßensa no seu projeto (no <code>FuzzyWuzzy</code> voc√™ era obrigado a usar uma li√ßensa GPL). N√£o muito interessante ü•±</li>
<li>√â mais rapida! Tem algumas melhorias na parte da implementa√ß√£o do algoritmo mas tamb√©m √© implementada em C++!!‚ö°Ô∏è‚ö°Ô∏è</li>
</ul>
<p><img src="https://media.giphy.com/media/HdcimOKferlkI/giphy.gif" alt=""></p>
<p>O qu√£o mais r√°pida? Vamos ver.</p>
<p>Usando a mesma estrat√©gia de antes:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># usando os mesmo exemplos do in√≠cio (e tamb√©m na biblioteca)</span>
<span class="kn">from</span> <span class="nn">rapidfuzz</span> <span class="kn">import</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">process</span>

<span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Atlanta Falcons&quot;</span><span class="p">,</span> <span class="s2">&quot;New York Jets&quot;</span><span class="p">,</span> <span class="s2">&quot;New York Giants&quot;</span><span class="p">,</span> <span class="s2">&quot;Dallas Cowboys&quot;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">timeit</span> process.extract(&quot;new york jets&quot;, choices, limit=2)  # s√≥ pra registrar o tempo
<span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">&quot;new york jets&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>8.23 ¬µs ¬± 173 ns per loop (mean ¬± std. dev. of 7 runs, 100000 loops each)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(&#39;New York Jets&#39;, 100.0, 1), (&#39;New York Giants&#39;, 78.57142857142857, 2)]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">timeit</span> process.extractOne(&quot;cowboys&quot;, choices) # s√≥ pra registrar o tempo
<span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="s2">&quot;cowboys&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>14.4 ¬µs ¬± 236 ns per loop (mean ¬± std. dev. of 7 runs, 100000 loops each)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;Dallas Cowboys&#39;, 90.0, 3)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Antes o c√≥digo demorou 89.3¬µs e 191¬µs, respectivamente. Agora, demoramos 8.23¬µs e 14.4¬µs (<strong>&lt;10%</strong> do tempo de antes)! Mas como escala? Vamos de novo olhar pro exemplo da deduplica√ß√£o de dados:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;rapidfuzz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 419 ms, sys: 26.7 ms, total: 445 ms
Wall time: 449 ms
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rec_id_x</th>
      <th>rec_id_y</th>
      <th>full_name_x</th>
      <th>full_name_y</th>
      <th>names</th>
      <th>fuzzywuzzy</th>
      <th>RapidFuzz</th>
      <th>rapidfuzz</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>rec-498-dup-0</td>
      <td>rec-372-dup-0</td>
      <td>claire crook</td>
      <td>talia ho</td>
      <td>(claire crook, talia ho)</td>
      <td>40</td>
      <td>40.000000</td>
      <td>40.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>rec-484-org</td>
      <td>rec-220-org</td>
      <td>jacynta hoffman</td>
      <td>tyler heerey</td>
      <td>(jacynta hoffman, tyler heerey)</td>
      <td>22</td>
      <td>22.222222</td>
      <td>22.222222</td>
    </tr>
    <tr>
      <th>2</th>
      <td>rec-410-dup-0</td>
      <td>rec-261-dup-0</td>
      <td>sachin connerty</td>
      <td>wilde</td>
      <td>(sachin connerty,  wilde)</td>
      <td>19</td>
      <td>19.047619</td>
      <td>19.047619</td>
    </tr>
    <tr>
      <th>3</th>
      <td>rec-54-org</td>
      <td>rec-246-dup-0</td>
      <td>emiily morrison</td>
      <td>burford jack</td>
      <td>(emiily morrison, burford jack)</td>
      <td>15</td>
      <td>14.814815</td>
      <td>14.814815</td>
    </tr>
    <tr>
      <th>4</th>
      <td>rec-370-dup-0</td>
      <td>rec-386-dup-0</td>
      <td>rourke webv</td>
      <td>dylan dolby</td>
      <td>(rourke webv, dylan dolby)</td>
      <td>18</td>
      <td>18.181818</td>
      <td>18.181818</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>E os resultados dos dois algoritmos s√£o exatamente iguais! (Com a pequena excess√£o que o <code>FuzzyWuzzy</code> retorna n√∫meros inteiros e o <code>RapidFuzz</code> retorna fra√ß√µes)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">timeit</span> df[&quot;names&quot;].apply(lambda x: fuzz.ratio(x[0], x[1]))
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>445 ms ¬± 25 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Menos 15% do tempo de antes!! S√≥ trocando a biblioteca!</p>
<p><img src="https://media.giphy.com/media/w9xG5hsxZlqtevPlJQ/giphy.gif" alt=""></p>
<p>Al√©m disso a documenta√ß√£o faz mais compara√ß√µes pra diferentes tarefas e como s√£o os n√∫meros com a maior quantidade de dados.</p>
<p><img src="https://raw.githubusercontent.com/maxbachmann/RapidFuzz/main/docs/img/scorer.svg?sanitize=true" alt="numero de pares de palavras comparadas por segundo"></p>
<p>Pra mais gr√°ficos, fica a <a href="https://maxbachmann.github.io/RapidFuzz/fuzz.html">documenta√ß√£o</a>.</p>
<h1 id="Uma-&#250;ltima-coisa...">Uma &#250;ltima coisa...<a class="anchor-link" href="#Uma-&#250;ltima-coisa..."> </a></h1><blockquote><p>A gente pode melhorar isso ainda mais quando quisermos deduplicar linhas na minha tabela?</p>
</blockquote>
<p>Sim. Mas n√£o na parte algoritmica. Na vida real, temos tamb√©m de sermos espertos na hora de computar as coisas. Se estivermos comparando endere√ßos por exemplo, a rua e n√∫mero talvez estejam diferentes, mas a cidade e estado provavelmente n√£o, especialmente porque numa grande parte esses vem de um dropdown, ent√£o os dados vem "limpos".</p>
<p>Nesses casos, ao inv√©s de criar todas as combina√ß√µes possiveis, a gente pode criar as combina√ß√µes dentro de cada grupo - no nosso exemplo quando os estados e cidades s√£o iguais. Reduzindo o n√∫mero de combina√ß√µes j√° reduz bastante o trabalho. E na maioria dos casos, √© <strong>ai</strong> que temos os maiores ganhos. E ainda por cima, existem bibliotecas como o <code>Record Linkage Toolkit</code> que s√£o feitos exatamente pra isso.
Ou seja, as vezes √© melhor sentar e pensar antes de ficar quebrando a cabe√ßa em como otimizar um algoritmo. üòá</p>
<p><img src="https://media.giphy.com/media/mRh4cLIYhrs9G/giphy.gif" alt=""></p>

</div>
</div>
</div>
</div>
 

